<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>d20 Roll</title>
<style>
  :root { --red:#e02424; --bg:#000; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--red);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .stage{position:relative;width:100%;height:100%;overflow:hidden}
  .result{position:absolute;inset:auto 0 8vh 0;text-align:center;font-weight:900;font-size:min(22vmin,180px);letter-spacing:.02em;pointer-events:none;text-shadow:0 0 24px rgba(224,36,36,.35)}
  .hint{position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);opacity:.7}
  .btn{position:absolute;top:1rem;right:1rem;background:transparent;border:2px solid var(--red);color:var(--red);
       padding:.5rem 1rem;border-radius:999px;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .dieWrap{position:absolute;width:min(22vmin,160px);height:min(22vmin,160px);display:grid;place-items:center;
           will-change:transform;filter:drop-shadow(0 0 14px rgba(224,36,36,.4))}
  svg{width:100%;height:100%}
  .d20{stroke:var(--red);fill:#0a0a0a;stroke-width:2}
  .facet{fill:#120000}
  .edge{stroke:var(--red);stroke-opacity:.65}

  /* Crit & Fumble effects */
  .pulse { animation: pulse 900ms ease-out; }
  @keyframes pulse { 0%{text-shadow:0 0 0 rgba(224,36,36,0)} 50%{text-shadow:0 0 40px rgba(224,36,36,.8)} 100%{text-shadow:0 0 0 rgba(224,36,36,0)} }
  .shake { animation: shake .6s linear 2; }
  @keyframes shake {
    0%,100%{ transform: translate3d(0,0,0) }
    20%{ transform: translate3d(-6px,2px,0) }
    40%{ transform: translate3d(7px,-3px,0) }
    60%{ transform: translate3d(-5px,1px,0) }
    80%{ transform: translate3d(4px,0,0) }
  }
  .flash { position:fixed;inset:0;background:rgba(224,36,36,.18);pointer-events:none;animation: fade 700ms ease-out forwards }
  @keyframes fade { from{opacity:1} to{opacity:0} }

  /* Confetti pieces (all red tones) */
  .confetti{ position:fixed; top:-10vh; width:6px; height:12px; background:var(--red);
             transform: translate3d(var(--x,0),-10vh,0) rotate(var(--r,0deg));
             opacity:.95; will-change:transform,opacity; }
  .confetti.tiny{ width:4px; height:8px; opacity:.85 }
  .confetti.big{ width:8px; height:14px; opacity:1 }
  .confetti.anim { animation: fall var(--t,1400ms) cubic-bezier(.2,.7,.2,1) forwards; }
  @keyframes fall {
    0%{ transform: translate3d(var(--x,0),-10vh,0) rotate(var(--r,0deg)) }
    100%{ transform: translate3d(var(--x2,0), 110vh,0) rotate(var(--r2,720deg)); opacity:0.2 }
  }
</style>
</head>
<body>
  <div class="stage" id="stage" aria-live="polite">
    <button class="btn" id="rollBtn">Roll d20</button>

    <div class="dieWrap" id="dieWrap" aria-hidden="true">
      <img id="dieImg" alt="d20" style="display:none;width:100%;height:100%;object-fit:contain;image-rendering:crisp-edges" src="die.png">
      <!-- fallback SVG d20 -->
      <svg id="dieSvg" viewBox="-52 -52 104 104" role="img" aria-label="d20">
        <g class="d20">
          <polygon class="facet" points="0,-48 28,-38 45,-12 36,22 8,46 -8,46 -36,22 -45,-12 -28,-38 0,-48"/>
          <g class="edge" fill="none">
            <polygon points="0,-48 28,-38 45,-12 36,22 8,46 -8,46 -36,22 -45,-12 -28,-38 0,-48"/>
            <path d="M0,-48 L0,8 M28,-38 L0,8 M-28,-38 L0,8 M45,-12 L-8,46 M-45,-12 L8,46 M36,22 L-36,22"/>
          </g>
        </g>
      </svg>
    </div>

    <div class="result" id="result">—</div>
    <div class="hint" id="hint">Tap / click / press R to roll</div>
  </div>

<script>
  const stage = document.getElementById('stage');
  const dieWrap = document.getElementById('dieWrap');
  const dieImg = document.getElementById('dieImg');
  const dieSvg = document.getElementById('dieSvg');
  const resultEl = document.getElementById('result');
  const btn = document.getElementById('rollBtn');

  // Prefer die.png if present
  dieImg.addEventListener('load', ()=>{ dieImg.style.display='block'; dieSvg.style.display='none'; });
  dieImg.addEventListener('error', ()=>{ dieImg.style.display='none'; dieSvg.style.display='block'; });

  const PAD_VMIN = 3; // keep the die away from the edges
  function rand20(){ return Math.floor(Math.random()*20)+1; }

  function pickPath() {
    const rect = stage.getBoundingClientRect();
    const W = rect.width, H = rect.height;
    const dRect = dieWrap.getBoundingClientRect();
    const DW = dRect.width, DH = dRect.height;
    const pad = Math.max(W, H) * (PAD_VMIN / 100);
    const xmin = pad, xmax = W - DW - pad;
    const ymin = pad, ymax = H - DH - pad;

    const dirs = ['LR','RL','TB','BT','TLBR','BRTL','TRBL','BLTR'];
    const dir = dirs[Math.floor(Math.random()*dirs.length)];

    let x0,y0,x1,y1;
    switch(dir){
      case 'LR':  x0=xmin; x1=xmax; y0=y1=ymin+Math.random()*(ymax-ymin); break;
      case 'RL':  x0=xmax; x1=xmin; y0=y1=ymin+Math.random()*(ymax-ymin); break;
      case 'TB':  y0=ymin; y1=ymax; x0=x1=xmin+Math.random()*(xmax-xmin); break;
      case 'BT':  y0=ymax; y1=ymin; x0=x1=xmin+Math.random()*(xmax-xmin); break;
      case 'TLBR':x0=xmin; y0=ymin; x1=xmax; y1=ymax; break;
      case 'BRTL':x0=xmax; y0=ymax; x1=xmin; y1=ymin; break;
      case 'TRBL':x0=xmax; y0=ymin; x1=xmin; y1=ymax; break;
      case 'BLTR':x0=xmin; y0=ymax; x1=xmax; y1=ymin; break;
    }
    const dist = Math.hypot(x1-x0, y1-y0);
    const spins = (dist / Math.min(W,H)) * (2 + Math.random()*2) * (Math.random()<0.5?1:-1);
    return {x0,y0,x1,y1,spins};
  }

  let spinning = false;

  function roll(){
    if(spinning) return;
    spinning = true;
    resultEl.textContent = '…';
    resultEl.classList.remove('pulse');

    const { x0,y0,x1,y1,spins } = pickPath();
    let t0 = 0;
    const dur = 1600;
    const startDeg = Math.floor(Math.random()*360);
    const easeOut = p => 1 - Math.pow(1-p,3);

    function frame(ts){
      if(!t0) t0 = ts;
      const p = Math.min((ts - t0)/dur, 1);
      const e = easeOut(p);
      const x = x0 + (x1-x0) * e;
      const y = y0 + (y1-y0) * e;
      const rot = startDeg + spins * 360 * e;

      dieWrap.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${rot}deg)`;
      if (Math.random() < (1 - e) * 0.5) resultEl.textContent = rand20();

      if (p < 1) requestAnimationFrame(frame);
      else {
        const final = rand20();
        resultEl.textContent = final;
        endEffects(final);
        spinning = false;
      }
    }
    requestAnimationFrame(frame);
  }

  /* ---- Crit/Fumble effects ---- */
  function endEffects(n){
    if(n === 20){
      resultEl.classList.add('pulse');
      burstConfetti(90);
    } else if(n === 1){
      flashAndShake();
    }
  }

  function flashAndShake(){
    stage.classList.add('shake');
    const overlay = document.createElement('div');
    overlay.className = 'flash';
    document.body.appendChild(overlay);
    overlay.addEventListener('animationend', ()=> overlay.remove());
    setTimeout(()=> stage.classList.remove('shake'), 1400);
  }

  function burstConfetti(count=80){
    const W = window.innerWidth, H = window.innerHeight;
    for(let i=0;i<count;i++){
      const c = document.createElement('div');
      const sizeClass = i%7===0 ? 'big' : (i%5===0 ? 'tiny' : '');
      c.className = `confetti ${sizeClass} anim`;
      const x = (W*0.3) + Math.random()*W*0.4;     // center-ish burst
      const x2 = x + (Math.random()*W*0.5 - W*0.25);
      const r = Math.floor(Math.random()*360);
      const r2 = r + (Math.random()*720 - 360);
      const t = 1100 + Math.random()*900;

      c.style.setProperty('--x', x+'px');
      c.style.setProperty('--x2', x2+'px');
      c.style.setProperty('--r', r+'deg');
      c.style.setProperty('--r2', r2+'deg');
      c.style.setProperty('--t', t+'ms');

      document.body.appendChild(c);
      c.addEventListener('animationend', ()=> c.remove());
    }
  }

  /* ---- Wiring ---- */
  window.addEventListener('load', ()=>{
    if (!dieImg.complete) dieImg.src = 'die.png'; // probe
    dieWrap.style.left = '0px'; dieWrap.style.top = '0px';
    roll();
  });
  btn.addEventListener('click', roll);
  document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='r') roll(); });
  stage.addEventListener('click', e=>{
    if(e.target.closest('#rollBtn')) return;
    roll();
  }, {passive:true});

  // Re-roll after orientation/resize
  let resizeTO;
  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTO);
    resizeTO = setTimeout(()=>{ if(!spinning) roll(); }, 150);
  });
</script>
</body>
</html>
